import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, doc, setDoc, updateDoc, onSnapshot, 
  collection, deleteDoc, addDoc, getDocs, query, where, serverTimestamp 
} from 'firebase/firestore';
import { 
  getAuth, signInAnonymously, onAuthStateChanged, 
  createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut
} from 'firebase/auth';
import { 
  Plus, History, Gauge, Trash2, ChevronLeft, 
  Loader2, Clock, Users, LogOut, Shield, 
  Edit2, Bike, Search, ExternalLink, TrendingUp, 
  Eye, EyeOff, RotateCcw, ClipboardCheck, CreditCard, 
  ShieldCheck, FileText, Download, CalendarPlus, MinusCircle, AlertTriangle,
  Lock, CheckCircle2, UserPlus
} from 'lucide-react';

// --- CONFIGURAZIONE FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyA718KdmKNnvtYLsjkb3cH-hkVHwc8SEyc",
  authDomain: "garage-fd19b.firebaseapp.com",
  projectId: "garage-fd19b",
  storageBucket: "garage-fd19b.firebasestorage.app",
  messagingSenderId: "72192698630",
  appId: "1:72192698630:web:db80bd0150f62ab9199687"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "garage_snoopy_final";

const ADMIN_EMAIL = 'info@fabio-perrone.com';
const ADMIN_PASS = 'prova';
const SECRET_KEY = "GarageSnoopySafeKey2025!SuperSecret"; 
const ENC_PREFIX = "ENC_";

// --- UTILITY CRITTOGRAFIA ---
const cryptoUtils = {
    encrypt: (text, email = "") => {
        const val = String(text || "").trim();
        if (!val) return "";
        if (email && email.toLowerCase().includes("andrea")) return val;
        if (!window.CryptoJS) return val; 
        try { 
            const encrypted = window.CryptoJS.AES.encrypt(val, SECRET_KEY).toString();
            return ENC_PREFIX + encrypted; 
        } catch (e) { return val; }
    },
    decrypt: (text) => {
        const val = String(text || "");
        if (!val || !val.startsWith(ENC_PREFIX)) return val;
        if (!window.CryptoJS) return "...";
        try {
            const bytes = window.CryptoJS.AES.decrypt(val.replace(ENC_PREFIX, ""), SECRET_KEY);
            return bytes.toString(window.CryptoJS.enc.Utf8) || "Errore Decrittazione";
        } catch (e) { return "Errore Sicurezza"; }
    }
};

// --- COMPONENTI UI ---

const Modal = ({ isOpen, title, message, onConfirm, onCancel, variant = "danger" }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/90 backdrop-blur-sm animate-in fade-in">
      <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl space-y-6 text-center">
        <h3 className="text-xl font-black uppercase italic tracking-tighter text-slate-900">{String(title)}</h3>
        <p className="text-sm text-slate-500 font-medium">{String(message)}</p>
        <div className="flex flex-col gap-2 pt-2">
          <button onClick={onConfirm} className={`w-full ${variant === 'danger' ? 'bg-red-500' : 'bg-blue-600'} text-white p-4 rounded-2xl font-black uppercase text-xs shadow-lg active:scale-95 transition-transform italic`}>Conferma</button>
          <button onClick={onCancel} className="w-full bg-slate-100 text-slate-400 p-4 rounded-2xl font-black uppercase text-xs active:scale-95 transition-transform italic">Annulla</button>
        </div>
      </div>
    </div>
  );
};

const Header = ({ setView, view, onBack, session, onLogout }) => {
    const showBack = !['garage', 'login'].includes(view);
    const isAdmin = session?.role === 'admin' || session?.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase();

    return (
        <header className="bg-slate-900 text-white p-5 flex justify-between items-center shadow-lg sticky top-0 z-50 border-b border-slate-800">
            <div className="flex items-center gap-3">
                {showBack && (
                    <button onClick={onBack} className="p-2 bg-slate-800 rounded-xl active:scale-90 transition-transform"><ChevronLeft size={20} className="text-orange-500" /></button>
                )}
                <div className="flex items-center gap-2 cursor-pointer" onClick={() => session && setView('garage')}>
                    <div className="bg-white p-1 rounded-full"><Bike size={20} className="text-orange-500" /></div>
                    <h1 className="font-black italic uppercase tracking-tighter text-xl leading-none">Garage</h1>
                </div>
            </div>
            <div className="flex gap-2 items-center">
                {isAdmin && <button onClick={() => setView('admin')} className={`p-2 rounded-xl transition-all ${view === 'admin' ? 'bg-blue-600 shadow-glow' : 'bg-slate-800'}`}><Shield size={18}/></button>}
                {session && <button onClick={onLogout} className="p-2 bg-slate-800 text-red-400 rounded-xl active:scale-90"><LogOut size={18}/></button>}
            </div>
        </header>
    );
};

// --- APP ---

export default function App() {
  const [user, setUser] = useState(null);
  const [session, setSession] = useState(null);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState('login');
  const [searchQuery, setSearchQuery] = useState("");
  const [updateStatus, setUpdateStatus] = useState("");
  
  const [bikes, setBikes] = useState([]);
  const [selectedBikeId, setSelectedBikeId] = useState(null);
  const [activeBikeRaw, setActiveBikeRaw] = useState(null);
  const [allLogsRaw, setAllLogsRaw] = useState([]);
  const [allUsers, setAllUsers] = useState([]);
  const [modal, setModal] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {}, variant: 'danger' });

  const [loginForm, setLoginForm] = useState({ email: '', password: '' });
  const [loginError, setLoginError] = useState('');

  // Form Stati
  const [newBike, setNewBike] = useState({ model: '', targa: '', odometer: '', lastServiceKm: '', lastServiceDate: '', serviceIntervalKm: '10000', serviceIntervalMonths: '12', bolloDeadline: '', assicurazioneDeadline: '', bolloNum: '', assicurazioneNum: '', bolloLink: '', assicurazioneLink: '' });
  const [editingBike, setEditingBike] = useState(null);
  const [newUserForm, setNewUserForm] = useState({ email: '', password: '', role: 'user' });
  const [newLog, setNewLog] = useState({ type: '', items: [''], km: '', date: new Date().toISOString().split('T')[0], cost: '', category: 'Manutenzione', docLink: '' });

  const showToast = (m) => { setUpdateStatus(m); setTimeout(() => setUpdateStatus(""), 3000); };
  const closeModal = () => setModal(prev => ({ ...prev, isOpen: false }));

  // Librerie Esterne
  useEffect(() => {
    if (!window.CryptoJS) {
      const s = document.createElement('script');
      s.src = "https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js";
      document.head.appendChild(s);
    }
    if (!window.XLSX) {
      const s2 = document.createElement('script');
      s2.src = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js";
      document.head.appendChild(s2);
    }
  }, []);

  // --- FIREBASE SYNC ---

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const p = `artifacts/${appId}/public/data`;
    const unsubB = onSnapshot(collection(db, p, 'bikes'), s => setBikes(s.docs.map(d => ({ ...d.data(), id: d.id }))));
    const unsubL = onSnapshot(collection(db, p, 'logs'), s => setAllLogsRaw(s.docs.map(d => ({ ...d.data(), id: d.id }))));
    const unsubU = onSnapshot(collection(db, p, 'users'), s => setAllUsers(s.docs.map(d => ({ ...d.data(), id: d.id }))));
    return () => { unsubB(); unsubL(); unsubU(); };
  }, [user]);

  useEffect(() => {
    if (!user || !selectedBikeId) return;
    return onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'bikes', selectedBikeId), 
      s => s.exists() && setActiveBikeRaw({ ...s.data(), id: s.id })
    );
  }, [user, selectedBikeId]);

  // --- LOGICA LOGIN ---

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoginError('');
    const em = loginForm.email.toLowerCase().trim();
    const pw = loginForm.password;

    try {
        // 1. Prova Google Auth
        const userCredential = await signInWithEmailAndPassword(auth, em, pw);
        const userDoc = allUsers.find(u => u.email.toLowerCase() === em);
        setSession({ ...userDoc, email: em, uid: userCredential.user.uid });
        setView('garage');
        showToast("Accesso Sicuro");
    } catch (err) {
        // Log specifico per debug su GitHub/Siti ospitati
        if (err.code === 'auth/unauthorized-domain') {
            setLoginError("ERRORE: Dominio non autorizzato su Firebase Console.");
            return;
        }

        // 2. Fallback per Migrazione
        const legacyUser = allUsers.find(u => u.email.toLowerCase() === em && u.password === pw);
        if (legacyUser) {
            try {
                // Trovato nel vecchio db -> Creiamo account ufficiale su Google
                const newCredential = await createUserWithEmailAndPassword(auth, em, pw);
                setSession({ ...legacyUser, email: em, uid: newCredential.user.uid });
                setView('garage');
                showToast("Account migrato a Google!");
            } catch (migErr) {
                setLoginError("Errore durante la migrazione account.");
            }
        } else if (em === ADMIN_EMAIL.toLowerCase() && pw === ADMIN_PASS) {
            setSession({ email: ADMIN_EMAIL, role: 'admin' });
            setView('garage');
        } else {
            setLoginError("Credenziali errate.");
        }
    }
  };

  const handleLogout = async () => {
    await signOut(auth);
    setSession(null);
    setView('login');
  };

  // --- LOGICA DATI ---

  const activeBike = useMemo(() => {
    if (!activeBikeRaw) return null;
    const b = { ...activeBikeRaw };
    ['bolloNum', 'assicurazioneNum', 'bolloLink', 'assicurazioneLink'].forEach(k => b[k] = cryptoUtils.decrypt(b[k]));
    return b;
  }, [activeBikeRaw]);

  const logs = useMemo(() => {
    return (allLogsRaw || [])
      .filter(l => l.bikeId === selectedBikeId)
      .map(l => ({ ...l, docLink: cryptoUtils.decrypt(l.docLink) }))
      .sort((a,b) => new Date(b.date) - new Date(a.date));
  }, [allLogsRaw, selectedBikeId]);

  const totalCostValue = useMemo(() => logs.reduce((sum, log) => sum + (Number(log.cost) || 0), 0), [logs]);
  const costPerKm = useMemo(() => {
      const km = Number(activeBike?.odometer) || 0;
      return km > 0 ? (totalCostValue / km).toFixed(3) : "0.000";
  }, [activeBike, totalCostValue]);

  const visibleBikes = useMemo(() => {
    const isAdmin = session?.role === 'admin' || session?.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase();
    let list = isAdmin ? bikes : bikes.filter(b => b.userEmail?.toLowerCase() === session?.email?.toLowerCase());
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      list = list.filter(b => b.model?.toLowerCase().includes(q) || b.targa?.toLowerCase().includes(q));
    }
    return list;
  }, [bikes, session, searchQuery]);

  // --- RENDER ---

  if (loading) return (
    <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-orange-500 font-black uppercase gap-4">
        <Loader2 className="animate-spin" size={40} />
        Caricamento Sicuro...
    </div>
  );

  return (
    <div className="app-shell text-left text-slate-900 bg-white min-h-screen">
        <Header view={view} setView={setView} session={session} onBack={() => { if(view==='dashboard') setSelectedBikeId(null); setView(view==='dashboard'?'garage':'dashboard'); }} onLogout={handleLogout} />
        
        <main className="scroll-container hide-scrollbar pb-24 text-left">
          {view === 'login' && (
            <div className="p-8 pt-16 space-y-12 animate-in text-center">
                <div className="mx-auto w-fit border-2 border-orange-500 rounded-full p-6 bg-white shadow-xl text-orange-500"><Bike size={80} /></div>
                <div className="space-y-2">
                    <h2 className="text-3xl font-black uppercase italic tracking-tighter text-slate-900">Garage Fleet Pro</h2>
                    <p className="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Protezione Google Auth 2.0</p>
                </div>
                <form onSubmit={handleLogin} className="space-y-4 px-4 text-left">
                    <div className="relative">
                        <input required type="email" placeholder="Email Account" className="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl font-bold focus:border-orange-500 outline-none text-slate-900 transition-all pl-14" value={loginForm.email} onChange={e => setLoginForm({...loginForm, email: e.target.value})} />
                        <Users className="absolute left-5 top-1/2 -translate-y-1/2 text-slate-300" size={20} />
                    </div>
                    <div className="relative">
                        <input required type="password" placeholder="Password" className="w-full p-5 bg-slate-50 border-2 border-slate-100 rounded-3xl font-bold focus:border-orange-500 outline-none text-slate-900 transition-all pl-14" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} />
                        <Lock className="absolute left-5 top-1/2 -translate-y-1/2 text-slate-300" size={20} />
                    </div>
                    {loginError && <div className="p-3 bg-red-50 text-red-600 text-[10px] font-black uppercase text-center rounded-xl flex items-center justify-center gap-2 border border-red-100"><AlertTriangle size={14}/> {loginError}</div>}
                    <button className="w-full bg-slate-900 text-white p-5 rounded-2xl font-black uppercase shadow-xl hover:bg-black active:scale-95 transition-all mt-4 italic text-xl">Accedi</button>
                </form>
            </div>
          )}

          {view === 'garage' && session && (
            <div className="flex flex-col h-full animate-in text-left">
              <div className="p-6 bg-slate-50 border-b border-slate-100 text-left">
                <div className="flex justify-between items-end mb-6 text-left">
                  <div className="text-left text-slate-900">
                    <h2 className="text-4xl font-black uppercase italic leading-none">Garage</h2>
                    <p className="text-slate-400 text-[10px] font-black uppercase mt-2">I Tuoi Mezzi</p>
                  </div>
                  <button onClick={() => setView('addBike')} className="bg-orange-500 text-white p-4 rounded-2xl shadow-lg active:scale-95 transition-transform"><Plus/></button>
                </div>
                <div className="relative">
                  <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Search size={18} /></div>
                  <input className="w-full bg-white border-2 border-slate-100 rounded-2xl p-4 pl-12 font-bold outline-none text-sm shadow-sm text-slate-900" placeholder="Cerca veicolo..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                </div>
              </div>
              <div className="p-5 grid gap-4 text-left">
                {visibleBikes.map(b => (
                    <div key={b.id} onClick={() => { setSelectedBikeId(b.id); setView('dashboard'); }} className="bg-white border-2 border-slate-100 p-7 rounded-[3rem] shadow-sm flex justify-between items-center cursor-pointer active:scale-[0.98] transition-all hover:border-orange-200 group">
                        <div className="text-left text-slate-900">
                            <h3 className="font-black uppercase italic text-xl leading-none mb-2">{String(b.model || "")}</h3>
                            <div className="flex items-center gap-2">
                                <span className="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-lg text-[9px] font-black border border-slate-200 uppercase">{String(b.targa)}</span>
                                {session.role === 'admin' && <p className="text-[9px] font-bold text-orange-500 truncate lowercase opacity-60">{String(b.userEmail)}</p>}
                            </div>
                            <p className="text-slate-400 font-bold text-[11px] mt-2 italic">{(Number(b.odometer) || 0).toLocaleString()} KM TOTALI</p>
                        </div>
                        <Bike size={32} className="text-slate-100 group-hover:text-orange-500 transition-colors" />
                    </div>
                ))}
              </div>
            </div>
          )}

          {view === 'admin' && session?.role === 'admin' && (
            <div className="p-6 space-y-8 animate-in text-left text-slate-900">
                <h2 className="text-3xl font-black uppercase italic tracking-tighter">Admin Panel</h2>
                <div className="bg-blue-50 p-6 rounded-3xl border border-blue-100 text-left">
                    <p className="font-black text-blue-800 text-[10px] uppercase">Nota Tecnica GitHub</p>
                    <p className="text-[11px] text-blue-600 mt-2 font-medium">Se il login fallisce su GitHub, aggiungi il dominio nelle impostazioni di Authentication {"->"} Authorized domains nella console di Firebase.</p>
                </div>
            </div>
          )}

          {view === 'dashboard' && activeBike && (
            <div className="p-6 space-y-6 animate-in text-left text-slate-900">
                <div className="bg-slate-900 text-white p-8 rounded-[3rem] shadow-2xl overflow-hidden relative border border-slate-800 text-left">
                    <div className="relative z-10 text-left">
                        <div className="flex justify-between items-start">
                            <h2 className="text-3xl font-black uppercase tracking-tight italic leading-none text-orange-500">{String(activeBike.model || "")}</h2>
                            <button onClick={() => { setEditingBike({...activeBikeRaw}); setView('editBike'); }} className="p-2 bg-white/10 rounded-lg text-white"><Edit2 size={18} /></button>
                        </div>
                        <p className="text-5xl font-black mt-4">{(Number(activeBike.odometer) || 0).toLocaleString()} <span className="text-sm opacity-40 uppercase">KM</span></p>
                    </div>
                    <Bike size={200} className="absolute -right-10 -bottom-10 opacity-10" />
                </div>
                <div className="grid grid-cols-2 gap-4 text-left">
                    <div className="p-5 bg-white border-2 border-slate-100 rounded-[2.5rem] shadow-sm text-left"><p className="text-[9px] font-black uppercase text-slate-400 mb-1">Costo / KM</p><p className="text-xl font-black text-slate-900">€ {costPerKm}</p></div>
                    <div className="p-5 bg-white border-2 border-slate-100 rounded-[2.5rem] shadow-sm text-left"><p className="text-[9px] font-black uppercase text-slate-400 mb-1">Spesa Totale</p><p className="text-xl font-black text-emerald-600">€ {totalCostValue.toLocaleString()}</p></div>
                </div>
                <div className="grid grid-cols-2 gap-4 text-center">
                    <button onClick={() => setView('history')} className="bg-white border-2 border-slate-100 p-8 rounded-[3rem] flex flex-col items-center gap-3 active:scale-95 text-slate-900 text-center"><History size={32} className="text-slate-400"/><span className="font-black uppercase text-xs">Cronologia</span></button>
                    <button onClick={() => setView('addLog')} className="bg-slate-900 text-white p-8 rounded-[3rem] flex flex-col items-center gap-3 active:scale-95 text-white text-center"><Plus size={32} className="text-orange-500"/><span className="font-black uppercase text-xs">Nuovo Log</span></button>
                </div>
            </div>
          )}

          {view === 'history' && (
            <div className="p-6 space-y-6 animate-in text-left">
                <h2 className="text-3xl font-black uppercase italic tracking-tighter text-slate-900">Registro Lavori</h2>
                <div className="space-y-4 pb-40 text-left">
                    {logs.map(l => (
                        <div key={l.id} className="bg-white border-2 border-slate-100 p-6 rounded-[3rem] shadow-sm space-y-4 text-left">
                            <div className="flex justify-between items-start text-left">
                                <div className="text-left space-y-1">
                                    <span className="bg-orange-100 text-orange-600 px-3 py-1 rounded-lg text-[9px] font-black uppercase">{String(l.category || "Manutenzione")}</span>
                                    <h4 className="font-black text-xl uppercase italic leading-tight text-slate-900">{String(l.type)}</h4>
                                    <p className="text-slate-400 font-bold text-xs flex items-center gap-1.5 mt-1"><Clock size={12}/> {new Date(l.date).toLocaleDateString('it-IT')}</p>
                                </div>
                                <div className="text-right text-slate-900"><p className="font-black text-sm text-left">{(Number(l.km)).toLocaleString()} KM</p><p className="text-emerald-600 font-black text-lg">€{l.cost}</p></div>
                            </div>
                            {l.items && l.items.length > 0 && (
                                <div className="border-t pt-3 space-y-1.5 text-left text-slate-400">
                                    {l.items.filter(i => i).map((i, idx) => <p key={idx} className="text-[11px] font-medium flex items-start gap-2"><span>•</span> {String(i)}</p>)}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>
          )}

          {(view === 'addBike' || view === 'editBike') && (
            <div className="p-6 space-y-6 animate-in text-left text-slate-900 pb-40">
                <h2 className="text-3xl font-black uppercase italic tracking-tighter text-left">{view === 'addBike' ? 'Nuovo Veicolo' : 'Modifica Veicolo'}</h2>
                <form onSubmit={async (e) => {
                    e.preventDefault();
                    const curr = view === 'addBike' ? newBike : editingBike;
                    const data = { ...curr, odometer: Number(curr.odometer), lastServiceKm: Number(curr.lastServiceKm) };
                    if (view === 'addBike') { 
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bikes'), {...data, userEmail: String(session.email), createdAt: new Date().toISOString()}); 
                    } else { 
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bikes', editingBike.id), data); 
                    }
                    setView('garage'); setSelectedBikeId(null); setActiveBikeRaw(null); showToast("Salvato!");
                }} className="space-y-4 bg-white p-8 rounded-[3rem] border-2 border-slate-100 shadow-sm text-left">
                    <input required placeholder="Modello" className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold outline-none uppercase text-slate-900" value={view === 'addBike' ? newBike.model : editingBike.model} onChange={e => view === 'addBike' ? setNewBike({...newBike, model: e.target.value}) : setEditingBike({...editingBike, model: e.target.value})} />
                    <input placeholder="Targa" className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold outline-none uppercase text-slate-900" value={view === 'addBike' ? newBike.targa : editingBike.targa} onChange={e => view === 'addBike' ? setNewBike({...newBike, targa: e.target.value.toUpperCase()}) : setEditingBike({...editingBike, targa: e.target.value.toUpperCase()})} />
                    <div className="grid grid-cols-2 gap-3 text-left">
                        <input type="number" required placeholder="Km" className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold text-slate-900" value={view === 'addBike' ? newBike.odometer : editingBike.odometer} onChange={e => view === 'addBike' ? setNewBike({...newBike, odometer: e.target.value}) : setEditingBike({...editingBike, odometer: e.target.value})} />
                        <input type="number" required placeholder="Km Tagl." className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl font-bold text-slate-900" value={view === 'addBike' ? newBike.lastServiceKm : editingBike.lastServiceKm} onChange={e => view === 'addBike' ? setNewBike({...newBike, lastServiceKm: e.target.value}) : setEditingBike({...editingBike, lastServiceKm: e.target.value})} />
                    </div>
                    <button type="submit" className="w-full bg-slate-900 text-white p-6 rounded-3xl font-black uppercase shadow-xl active:scale-95 transition-all text-center italic mt-4 text-white">Salva Veicolo</button>
                </form>
            </div>
          )}

          {(view === 'addLog' || view === 'editLog') && (
            <div className="p-6 space-y-6 animate-in text-left text-slate-900 pb-40">
                <h2 className="text-3xl font-black uppercase italic tracking-tighter text-left">{view === 'addLog' ? 'Registra Lavoro' : 'Modifica Intervento'}</h2>
                <form onSubmit={async (e) => {
                    e.preventDefault();
                    const curr = view === 'addLog' ? newLog : editingLog;
                    const data = { ...curr, km: Number(curr.km), cost: Number(curr.cost), docLink: cryptoUtils.encrypt(curr.docLink, session.email) };
                    if (view === 'addLog') { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {...data, bikeId: selectedBikeId, createdAt: new Date().toISOString()}); }
                    else { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', editingLog.id), data); }
                    if (Number(curr.km) > (Number(activeBike.odometer))) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bikes', selectedBikeId), { odometer: Number(curr.km) });
                    setView('history'); showToast("Salvato!");
                }} className="space-y-4 bg-slate-900 text-white p-7 rounded-[3rem] text-left border border-slate-800 shadow-2xl">
                    <input required className="w-full p-4 bg-slate-800 rounded-xl outline-none border border-slate-700 font-bold text-white text-left" value={view === 'addLog' ? newLog.type : editingLog.type} onChange={e => view === 'addLog' ? setNewLog({...newLog, type: e.target.value}) : setEditingLog({...editingLog, type: e.target.value})} placeholder="Tipo Intervento" />
                    <div className="space-y-3 pt-2 text-left">
                        <div className="flex justify-between items-center text-white"><label className="text-[10px] font-black uppercase text-slate-500 ml-2">Voci Righe Storico</label><button type="button" onClick={() => { if(view==='addLog') setNewLog({...newLog, items: [...newLog.items, '']}); else setEditingLog({...editingLog, items: [...editingLog.items, '']}); }} className="text-orange-500 text-[10px] font-black uppercase active:scale-90 text-center">+ Voce</button></div>
                        {(view === 'addLog' ? newLog.items : editingLog.items).map((item, idx) => (
                            <div key={idx} className="flex gap-2 animate-in text-white"><input required className="flex-1 p-3.5 bg-slate-800 rounded-xl text-white outline-none text-xs border border-slate-700 text-left" value={item} onChange={e => { const u = [...(view==='addLog'?newLog.items:editingLog.items)]; u[idx] = e.target.value; if(view==='addLog') setNewLog({...newLog, items: u}); else setEditingLog({...editingLog, items: u}); }} placeholder={`Voce ${idx+1}`} />{(view==='addLog'?newLog.items:editingLog.items).length > 1 && <button type="button" onClick={() => { const u = [...(view==='addLog'?newLog.items:editingLog.items)]; u.splice(idx,1); if(view==='addLog') setNewLog({...newLog, items: u}); else setEditingLog({...editingLog, items: u}); }} className="text-red-400 p-2 text-center text-center"><MinusCircle size={20}/></button>}</div>
                        ))}
                    </div>
                    <div className="grid grid-cols-2 gap-3 text-left text-white">
                        <input required type="number" className="w-full p-4 bg-slate-800 rounded-xl outline-none font-bold text-left" placeholder="Km" value={view === 'addLog' ? newLog.km : editingLog.km} onChange={e => view === 'addLog' ? setNewLog({...newLog, km: e.target.value}) : setEditingLog({...editingLog, km: e.target.value})} />
                        <input required type="number" className="w-full p-4 bg-slate-800 rounded-xl outline-none font-bold text-left" placeholder="Spesa €" value={view === 'addLog' ? newLog.cost : editingLog.cost} onChange={e => view === 'addLog' ? setNewLog({...newLog, cost: e.target.value}) : setEditingLog({...editingLog, cost: e.target.value})} />
                    </div>
                    <button className="w-full bg-orange-500 text-white p-5 rounded-[2rem] font-black uppercase shadow-lg active:scale-95 italic mt-4 text-center">Salva Intervento</button>
                </form>
            </div>
          )}
        </main>

        {session && (
            <nav className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t flex justify-around p-3 pb-8 md:p-4 max-w-md mx-auto rounded-t-[2.5rem] shadow-[0_-10px_40px_rgba(0,0,0,0.12)] z-40 text-slate-900">
                <button onClick={() => setView('dashboard')} className={`flex flex-col items-center gap-1.5 transition-all ${view === 'dashboard' ? 'text-orange-500 scale-110' : 'text-slate-400 opacity-60'}`}><Gauge size={24} /><span className="text-[9px] font-black uppercase tracking-tighter">Stato</span></button>
                <button onClick={() => setView('history')} className={`flex flex-col items-center gap-1.5 transition-all ${view === 'history' ? 'text-orange-500 scale-110' : 'text-slate-400 opacity-60'}`}><History size={24} /><span className="text-[9px] font-black uppercase tracking-tighter">Registro</span></button>
                <div className="relative -top-12">
                    <button onClick={() => setView('addLog')} className="bg-orange-500 text-white p-5 rounded-full shadow-xl border-4 border-white active:scale-90 transition-all hover:rotate-90 text-center"><Plus size={32} strokeWidth={3} /></button>
                </div>
                <div className="w-12" />
            </nav>
        )}
        
        {updateStatus && (
            <div className="fixed bottom-28 left-5 right-5 z-[110] p-4 bg-slate-900 text-white rounded-2xl font-bold shadow-2xl animate-in slide-in-from-bottom-5 flex items-center gap-3 text-left">
                <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse text-left" />
                <span className="text-xs uppercase tracking-widest text-left">{String(updateStatus)}</span>
            </div>
        )}
        
        <Modal isOpen={modal.isOpen} title={modal.title} message={modal.message} variant={modal.variant} onConfirm={modal.onConfirm} onCancel={closeModal} />
    </div>
  );
}
