<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garage Snoopy Pro</title>
    
    <!-- Librerie via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; margin: 0; overflow: hidden; }
        .app-shell { display: flex; flex-direction: column; height: 100vh; max-width: 480px; margin: 0 auto; background-color: #0f172a; position: relative; border-left: 1px solid #1e293b; border-right: 1px solid #1e293b; }
        .scroll-container { flex: 1; overflow-y: auto; padding-bottom: 120px; scroll-behavior: smooth; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-active:active { transform: scale(0.95); transition: transform 0.1s; }
        .toast-container { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); width: 90%; z-index: 1000; }
        .modal-overlay { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // ==========================================
        // 1. CONFIGURAZIONE
        // ==========================================
        const APP_VERSION = "1.7.9";
        const ADMIN_EMAIL = 'info@fabio-perrone.com';
        const ADMIN_PASS = 'prova';
        const SECRET_KEY = "GarageSnoopySafeKey2025!SuperSecret"; 
        const ENC_PREFIX = "ENC_";

        const firebaseConfig = {
            apiKey: "AIzaSyA718KdmKNnvtYLsjkb3cH-hkVHwc8SEyc",
            authDomain: "garage-fd19b.firebaseapp.com",
            projectId: "garage-fd19b",
            storageBucket: "garage-fd19b.firebasestorage.app",
            messagingSenderId: "72192698630",
            appId: "1:72192698630:web:db80bd0150f62ab9199687"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "garage_snoopy_final";

        const cryptoUtils = {
            encrypt: (text) => {
                if (!text) return "";
                return ENC_PREFIX + CryptoJS.AES.encrypt(String(text), SECRET_KEY).toString();
            },
            decrypt: (text) => {
                if (!text || !String(text).startsWith(ENC_PREFIX)) return text || "";
                try {
                    const bytes = CryptoJS.AES.decrypt(text.replace(ENC_PREFIX, ""), SECRET_KEY);
                    return bytes.toString(CryptoJS.enc.Utf8);
                } catch (e) { return "Errore"; }
            }
        };

        const Icon = ({ name, size = "1x", className = "" }) => <i className={`fas fa-${name} fa-${size} ${className}`}></i>;

        function App() {
            const [view, setView] = useState('login');
            const [user, setUser] = useState(null);
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // Dati
            const [bikes, setBikes] = useState([]);
            const [allLogs, setAllLogs] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            
            // Selezione
            const [selectedBikeId, setSelectedBikeId] = useState(null);
            const [activeBikeRaw, setActiveBikeRaw] = useState(null);
            const [searchQuery, setSearchQuery] = useState("");
            const [status, setStatus] = useState("");
            const [confirmDelete, setConfirmDelete] = useState(null);
            
            // Form Stati
            const [loginForm, setLoginForm] = useState({ email: '', password: '' });
            const [newUser, setNewUser] = useState({ email: '', password: '', role: 'user' });
            const [newBike, setNewBike] = useState({ model: '', targa: '', odometer: '', lastServiceKm: '', lastServiceDate: '', serviceIntervalKm: '10000', serviceIntervalMonths: '12' });
            const [editingBike, setEditingBike] = useState(null);
            const [newLog, setNewLog] = useState({ type: '', items: [''], km: '', date: new Date().toISOString().split('T')[0], cost: '' });
            const [editingLog, setEditingLog] = useState(null);
            const [editingUser, setEditingUser] = useState(null);

            const showToast = (m) => { setStatus(m); setTimeout(() => setStatus(""), 4000); };
            const isAdmin = session?.role === 'admin' || session?.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase();

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if(!u) auth.signInAnonymously().catch(()=>{});
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            // SINCRONIZZAZIONE DATI REALE-TIME (Fix caricamento log)
            useEffect(() => {
                if (!user) return;
                const pathBase = `artifacts/garage_snoopy_final/public/data`;
                
                const unsubB = db.collection(`${pathBase}/bikes`).onSnapshot(s => setBikes(s.docs.map(d => ({...d.data(), id: d.id}))));
                const unsubL = db.collection(`${pathBase}/logs`).onSnapshot(s => setAllLogs(s.docs.map(d => ({...d.data(), id: d.id}))));
                const unsubU = db.collection(`${pathBase}/users`).onSnapshot(s => {
                    const list = s.docs.map(d => ({...d.data(), id: d.id}));
                    setAllUsers(list);
                    if (user?.email) {
                        const me = list.find(u => u.email.toLowerCase() === user.email.toLowerCase());
                        if (me) setSession(prev => ({...prev, ...me}));
                    }
                });
                return () => { unsubB(); unsubL(); unsubU(); };
            }, [user]);

            useEffect(() => {
                if (!user || !selectedBikeId) { setActiveBikeRaw(null); return; }
                const path = `artifacts/garage_snoopy_final/public/data/bikes/${selectedBikeId}`;
                return db.doc(path).onSnapshot(s => {
                    if (s.exists) setActiveBikeRaw({ ...s.data(), id: s.id });
                });
            }, [user, selectedBikeId]);

            const handleLogin = async (e) => {
                e.preventDefault();
                const em = loginForm.email.toLowerCase().trim();
                const pw = loginForm.password;
                try {
                    const cred = await auth.signInWithEmailAndPassword(em, pw);
                    const profile = allUsers.find(u => u.email.toLowerCase() === em);
                    setSession({ ...profile, email: em, uid: cred.user.uid });
                    setView('garage');
                } catch (err) {
                    const legacy = allUsers.find(u => u.email.toLowerCase() === em && u.password === pw);
                    if (legacy) {
                        const nc = await auth.createUserWithEmailAndPassword(em, pw);
                        setSession({ ...legacy, email: em, uid: nc.user.uid });
                        setView('garage');
                        showToast("Accesso Sicuro ✓");
                    } else if (em === ADMIN_EMAIL.toLowerCase() && pw === ADMIN_PASS) {
                        setSession({ email: em, role: 'admin' });
                        setView('garage');
                    } else { showToast("Credenziali errate"); }
                }
            };

            const handleSaveLog = async (e) => {
                e.preventDefault();
                if (!selectedBikeId) { showToast("Scegli un veicolo!"); return; }
                try {
                    const path = `artifacts/garage_snoopy_final/public/data/logs`;
                    const currentSource = editingLog || newLog;
                    const data = { 
                        ...currentSource, 
                        bikeId: selectedBikeId, 
                        km: Number(currentSource.km), 
                        cost: Number(currentSource.cost) 
                    };
                    
                    if (editingLog) {
                        await db.doc(`${path}/${editingLog.id}`).update(data);
                        showToast("Modificato ✓");
                    } else {
                        await db.collection(path).add({ ...data, createdAt: new Date().toISOString() });
                        showToast("Salvato ✓");
                    }
                    if (Number(currentSource.km) > (Number(activeBikeRaw?.odometer || 0))) {
                        await db.doc(`artifacts/garage_snoopy_final/public/data/bikes/${selectedBikeId}`).update({ odometer: Number(currentSource.km) });
                    }
                    setEditingLog(null);
                    setNewLog({ type: '', items: [''], km: '', date: new Date().toISOString().split('T')[0], cost: '' });
                    setView('history');
                } catch (err) { showToast("Errore salvataggio"); }
            };

            const handleDeleteBike = async (id) => {
                try {
                    await db.doc(`artifacts/garage_snoopy_final/public/data/bikes/${id}`).delete();
                    setConfirmDelete(null);
                    setSelectedBikeId(null);
                    setView('garage');
                    showToast("Rimosso ✓");
                } catch (err) { showToast("Errore cancellazione"); }
            };

            const logs = useMemo(() => {
                let filtered = allLogs || [];
                if (selectedBikeId) filtered = allLogs.filter(l => l.bikeId === selectedBikeId);
                return filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
            }, [allLogs, selectedBikeId]);

            const activeBike = useMemo(() => {
                if (!activeBikeRaw) return null;
                return { ...activeBikeRaw };
            }, [activeBikeRaw]);

            const totalSpent = useMemo(() => logs.reduce((s, l) => s + (Number(l.cost) || 0), 0), [logs]);
            const costPerKm = useMemo(() => {
                const km = Number(activeBike?.odometer) || 0;
                return km > 0 ? (totalSpent / km).toFixed(3) : "0.000";
            }, [activeBike, totalSpent]);

            const filteredBikes = useMemo(() => {
                let list = isAdmin ? bikes : bikes.filter(b => b.userEmail?.toLowerCase() === session?.email?.toLowerCase());
                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    list = list.filter(b => b.model?.toLowerCase().includes(q) || b.targa?.toLowerCase().includes(q));
                }
                return list;
            }, [bikes, session, isAdmin, searchQuery]);

            if (loading) return <div className="h-screen flex items-center justify-center text-orange-500 font-black italic animate-pulse text-center">CARICAMENTO GARAGE...</div>;

            return (
                <div className="app-shell shadow-2xl">
                    <header className="p-5 bg-slate-900 flex justify-between items-center border-b border-slate-800 sticky top-0 z-50 text-white">
                        <div className="flex items-center gap-3">
                            {['dashboard', 'history', 'admin', 'addLog', 'editLog', 'addBike', 'editBike'].includes(view) && (
                                <button onClick={() => { if(view==='dashboard' || view==='admin' || view==='history') { setSelectedBikeId(null); setView('garage'); } else setView('dashboard'); }} className="p-2 bg-slate-800 rounded-lg text-orange-500 active:scale-90"><Icon name="chevron-left"/></button>
                            )}
                            <div className="flex flex-col cursor-pointer" onClick={() => session && setView('garage')}>
                                <h1 className="text-xl font-black italic uppercase text-orange-500 tracking-tighter leading-none">Garage</h1>
                                {session && <span className="text-[8px] font-bold text-slate-500 uppercase tracking-widest mt-1">Build v{APP_VERSION}</span>}
                            </div>
                        </div>
                        <div className="flex gap-2">
                            {isAdmin && <button onClick={() => setView('admin')} className={`p-2 rounded-lg ${view === 'admin' ? 'bg-blue-600 shadow-lg' : 'bg-slate-800 text-slate-400'}`}><Icon name="shield-alt"/></button>}
                            {session && <button onClick={() => { auth.signOut(); setSession(null); setView('login'); }} className="p-2 bg-slate-800 text-red-400 rounded-lg"><Icon name="sign-out-alt"/></button>}
                        </div>
                    </header>

                    <main className="scroll-container hide-scrollbar text-left">
                        {view === 'login' && (
                            <div className="p-8 pt-16 text-center animate-in">
                                <div className="mx-auto w-fit p-6 bg-slate-800 rounded-full mb-8 shadow-2xl border border-slate-700 text-center"><Icon name="motorcycle" size="4x" className="text-orange-500"/></div>
                                <h2 className="text-3xl font-black italic uppercase mb-8 text-slate-100">Area Riservata</h2>
                                <form onSubmit={handleLogin} className="space-y-4">
                                    <input required type="email" placeholder="Email" className="w-full p-5 bg-slate-800 border-none rounded-2xl outline-none focus:ring-2 ring-orange-500 text-white text-left" value={loginForm.email} onChange={e => setLoginForm({...loginForm, email: e.target.value})}/>
                                    <input required type="password" placeholder="Password" className="w-full p-5 bg-slate-800 border-none rounded-2xl outline-none focus:ring-2 ring-orange-500 text-white text-left" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})}/>
                                    <button className="w-full bg-gradient-to-r from-orange-600 to-orange-400 p-5 rounded-2xl font-black uppercase italic shadow-lg active:scale-95 transition-all text-white">Entra nel Garage</button>
                                </form>
                                <p className="text-[10px] text-slate-500 mt-10 uppercase font-bold tracking-widest opacity-50 text-center">Build v{APP_VERSION}</p>
                            </div>
                        )}

                        {view === 'garage' && session && (
                            <div className="p-5 animate-in space-y-4 text-left text-slate-100">
                                <div className="flex justify-between items-end mb-6 text-left text-slate-100">
                                    <h2 className="text-4xl font-black italic uppercase leading-none">Garage</h2>
                                    {isAdmin && <button onClick={() => setView('addBike')} className="p-4 bg-orange-500 rounded-2xl shadow-lg active:scale-90 text-white"><Icon name="plus"/></button>}
                                </div>
                                <div className="relative mb-6 text-left">
                                    <Icon name="search" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"/>
                                    <input className="w-full p-4 pl-12 bg-slate-800 border border-slate-700 rounded-2xl text-sm outline-none text-white text-left" placeholder="Cerca veicolo..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}/>
                                </div>
                                {filteredBikes.map(b => (
                                    <div key={b.id} onClick={() => { setSelectedBikeId(b.id); setView('dashboard'); }} className="p-6 bg-slate-800 rounded-[2.5rem] flex justify-between items-center border border-slate-700 hover:border-orange-500/50 transition-all cursor-pointer group active:scale-[0.98]">
                                        <div className="flex-1 text-left">
                                            <h3 className="font-black uppercase italic text-xl leading-none mb-1 text-white text-left">{b.model}</h3>
                                            <span className="text-[10px] font-black border border-slate-600 px-2 py-0.5 rounded text-slate-400 uppercase text-left">{b.targa}</span>
                                            <p className="text-slate-500 font-bold text-xs mt-2 italic text-left">{(Number(b.odometer)).toLocaleString()} KM</p>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <Icon name="motorcycle" size="2x" className="text-slate-700 group-hover:text-orange-500 transition-colors"/>
                                            {isAdmin && <button onClick={(e) => { e.stopPropagation(); setConfirmDelete(b); }} className="p-3 bg-red-500/10 text-red-500 rounded-xl hover:bg-red-500/20 transition-all text-center"><Icon name="trash-alt"/></button>}
                                        </div>
                                    </div>
                                ))}
                                {filteredBikes.length === 0 && <p className="text-center py-20 text-slate-600 font-bold uppercase text-xs italic">Nessun mezzo trovato</p>}
                            </div>
                        )}

                        {view === 'dashboard' && activeBike && (
                            <div className="p-6 animate-in space-y-6 text-left">
                                <div className="bg-slate-900 p-8 rounded-[3rem] border border-slate-800 relative overflow-hidden shadow-2xl text-left text-slate-100">
                                    <div className="flex justify-between items-start relative z-10 text-left">
                                        <h2 className="text-3xl font-black uppercase italic text-orange-500 text-left">{activeBike.model}</h2>
                                        {isAdmin && <button onClick={() => { setEditingBike({...activeBikeRaw}); setView('editBike'); }} className="p-2 text-blue-400/50 hover:text-blue-400 text-center"><Icon name="edit"/></button>}
                                    </div>
                                    <p className="text-6xl font-black mt-4 text-white text-left">{(Number(activeBike.odometer)).toLocaleString()} <span className="text-sm text-slate-500 uppercase">KM</span></p>
                                    <Icon name="motorcycle" size="6x" className="absolute -right-8 -bottom-8 opacity-5"/>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="p-5 bg-slate-800/50 rounded-[2rem] border border-slate-800 text-center text-slate-100 text-left"><p className="text-[9px] uppercase font-black text-slate-500 mb-1">Costo / KM</p><p className="text-xl font-black text-white text-left">€ {costPerKm}</p></div>
                                    <div className="p-5 bg-slate-800/50 rounded-[2rem] border border-slate-800 text-center text-slate-100 text-left"><p className="text-[9px] uppercase font-black text-slate-500 mb-1">Spesa Totale</p><p className="text-xl font-black text-emerald-400 text-left">€ {totalSpent.toLocaleString()}</p></div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 text-center">
                                    <button onClick={() => setView('history')} className="p-8 bg-slate-800 rounded-[2.5rem] flex flex-col items-center gap-3 border border-slate-700 active:scale-95 text-slate-100 text-center"><Icon name="history" size="2x" className="text-slate-500"/><span className="font-black uppercase text-xs">Storico</span></button>
                                    <button onClick={() => setView('addLog')} className="p-8 bg-white text-slate-900 rounded-[2.5rem] flex flex-col items-center gap-3 active:scale-95 shadow-xl text-center"><Icon name="plus" size="2x" className="text-orange-500"/><span className="font-black uppercase text-xs">Nuovo Log</span></button>
                                </div>
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="p-6 animate-in space-y-6 text-left">
                                <h2 className="text-3xl font-black italic uppercase text-left text-slate-100 text-left">Registro Lavori</h2>
                                <div className="space-y-4 pb-40 text-left text-slate-100">
                                    {logs.map(l => (
                                        <div key={l.id} className="p-6 bg-slate-800 rounded-[2.5rem] border border-slate-700 space-y-4 shadow-sm text-left">
                                            <div className="flex justify-between items-start text-left">
                                                <div className="text-left flex-1">
                                                    <span className="bg-orange-500/10 text-orange-500 px-2 py-1 rounded text-[8px] font-black uppercase text-left">Intervento</span>
                                                    <h4 className="font-black text-xl uppercase italic text-white mt-1 text-left">{l.type}</h4>
                                                    {!selectedBikeId && <p className="text-[10px] text-slate-400 font-black mt-1 uppercase tracking-widest text-left">Moto: {bikes.find(b => b.id === l.bikeId)?.model || '?'}</p>}
                                                    <p className="text-slate-500 font-bold text-[10px] mt-1 text-left"><Icon name="calendar-alt" className="mr-1"/> {new Date(l.date).toLocaleDateString('it-IT')}</p>
                                                </div>
                                                <div className="flex items-center gap-3 text-right">
                                                    <div className="text-right">
                                                        <p className="font-black text-white text-left">{(Number(l.km)).toLocaleString()} KM</p>
                                                        <p className="text-emerald-400 font-black text-lg text-left">€ {l.cost}</p>
                                                    </div>
                                                    {isAdmin && <button onClick={() => { setEditingLog({...l}); setView('editLog'); }} className="p-3 bg-blue-500/10 text-blue-400 rounded-xl text-center"><Icon name="edit"/></button>}
                                                </div>
                                            </div>
                                            {l.items && l.items.length > 0 && l.items[0] !== "" && (
                                                <div className="border-t border-slate-700 pt-3 space-y-1.5 opacity-60 text-slate-400 text-left">
                                                    {l.items.filter(i => i).map((i, idx) => <p key={idx} className="text-[11px] font-medium flex items-start gap-2 text-left"><span>•</span> {i}</p>)}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    {logs.length === 0 && <p className="text-center py-20 text-slate-600 font-bold uppercase text-xs italic text-center">Nessun lavoro registrato</p>}
                                </div>
                            </div>
                        )}

                        {(view === 'addLog' || view === 'editLog') && (
                            <div className="p-6 animate-in space-y-6 pb-40 text-left text-slate-100">
                                <h2 className="text-3xl font-black italic uppercase text-white text-left">{view === 'addLog' ? 'Nuovo Lavoro' : 'Modifica'}</h2>
                                <form onSubmit={handleSaveLog} className="bg-slate-800 p-8 rounded-[3rem] border border-slate-700 space-y-4 shadow-2xl text-left">
                                    <input required placeholder="Tipo Intervento" className="w-full p-4 bg-slate-900 rounded-2xl outline-none font-bold text-white text-left" 
                                        value={view === 'addLog' ? newLog.type : editingLog.type} 
                                        onChange={e => {
                                            const val = e.target.value;
                                            if(view==='addLog') setNewLog({...newLog, type: val}); else setEditingLog({...editingLog, type: val});
                                        }}
                                    />
                                    
                                    <div className="space-y-3 pt-2 text-left">
                                        <div className="flex justify-between items-center text-slate-500 font-black uppercase text-[10px] px-2 text-left text-left">
                                            <span>Voci registro (dettagli)</span>
                                            <button type="button" onClick={() => {
                                                const target = view === 'addLog' ? newLog : editingLog;
                                                const setter = view === 'addLog' ? setNewLog : setEditingLog;
                                                setter({...target, items: [...target.items, '']});
                                            }} className="text-orange-500 font-black">+ VOCE</button>
                                        </div>
                                        {(view === 'addLog' ? newLog.items : editingLog.items).map((item, idx) => (
                                            <div key={idx} className="flex gap-2 animate-in text-white text-left">
                                                <input required className="flex-1 p-3.5 bg-slate-900 rounded-xl outline-none text-xs text-white text-left" 
                                                    value={item} 
                                                    onChange={e => { 
                                                        const target = view === 'addLog' ? newLog : editingLog;
                                                        const setter = view === 'addLog' ? setNewLog : setEditingLog;
                                                        const u = [...target.items]; 
                                                        u[idx] = e.target.value; 
                                                        setter({...target, items: u}); 
                                                    }} 
                                                    placeholder={`Cambio Olio, Filtri...`} 
                                                />
                                                {(view === 'addLog' ? newLog.items : editingLog.items).length > 1 && (
                                                    <button type="button" onClick={() => { 
                                                        const target = view === 'addLog' ? newLog : editingLog;
                                                        const setter = view === 'addLog' ? setNewLog : setEditingLog;
                                                        const u = [...target.items]; 
                                                        u.splice(idx,1); 
                                                        setter({...target, items: u}); 
                                                    }} className="text-red-500 p-2 text-center"><Icon name="minus-circle"/></button>
                                                )}
                                            </div>
                                        ))}
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 pt-2 text-left">
                                        <div className="space-y-1 text-left"><label className="text-[10px] font-black uppercase text-slate-500 ml-2">Km</label><input required type="number" className="w-full p-4 bg-slate-900 rounded-2xl outline-none font-bold text-white text-left" value={view === 'addLog' ? newLog.km : editingLog.km} onChange={e => {
                                            const val = e.target.value;
                                            if(view==='addLog') setNewLog({...newLog, km: val}); else setEditingLog({...editingLog, km: val});
                                        }}/></div>
                                        <div className="space-y-1 text-left"><label className="text-[10px] font-black uppercase text-slate-500 ml-2">Costo €</label><input required type="number" className="w-full p-4 bg-slate-900 rounded-2xl outline-none font-bold text-white text-left" value={view === 'addLog' ? newLog.cost : editingLog.cost} onChange={e => {
                                            const val = e.target.value;
                                            if(view==='addLog') setNewLog({...newLog, cost: val}); else setEditingLog({...editingLog, cost: val});
                                        }}/></div>
                                    </div>
                                    <button className="w-full bg-orange-500 p-5 rounded-2xl font-black uppercase italic shadow-lg active:scale-95 transition-all mt-4 text-white text-center">Salva Intervento</button>
                                </form>
                            </div>
                        )}

                        {(view === 'addBike' || view === 'editBike') && (
                            <div className="p-6 animate-in space-y-6 pb-40 text-left text-slate-100">
                                <h2 className="text-3xl font-black italic uppercase text-white text-left">{view === 'addBike' ? 'Aggiungi Veicolo' : 'Modifica'}</h2>
                                <form onSubmit={async (e) => {
                                    e.preventDefault();
                                    const curr = view === 'addBike' ? newBike : editingBike;
                                    const path = `artifacts/garage_snoopy_final/public/data/bikes`;
                                    const dataToSave = {
                                        ...curr,
                                        odometer: Number(curr.odometer),
                                        lastServiceKm: Number(curr.lastServiceKm),
                                        serviceIntervalKm: Number(curr.serviceIntervalKm),
                                        serviceIntervalMonths: Number(curr.serviceIntervalMonths)
                                    };
                                    if (view === 'addBike') { 
                                        await db.collection(path).add({...dataToSave, userEmail: session.email, createdAt: new Date().toISOString()}); 
                                    } else { 
                                        await db.doc(`${path}/${editingBike.id}`).update(dataToSave); 
                                    }
                                    setView('garage'); showToast("Salvato ✓");
                                }} className="bg-slate-800 p-8 rounded-[3rem] border border-slate-700 space-y-4 shadow-2xl text-left">
                                    <div className="space-y-1 text-left"><label className="text-[10px] font-black uppercase text-slate-500 ml-2">Modello</label><input required className="w-full p-4 bg-slate-900 rounded-2xl outline-none font-bold text-white text-left" value={view === 'addBike' ? newBike.model : editingBike.model} onChange={e => view === 'addBike' ? setNewBike({...newBike, model: e.target.value}) : setEditingBike({...editingBike, model: e.target.value})} /></div>
                                    <div className="space-y-1 text-left"><label className="text-[10px] font-black uppercase text-slate-500 ml-2">Targa</label><input required className="w-full p-4 bg-slate-900 rounded-2xl outline-none font-bold text-white text-left uppercase text-left" value={view === 'addBike' ? newBike.targa : editingBike.targa} onChange={e => view === 'addBike' ? setNewBike({...newBike, targa: e.target.value}) : setEditingBike({...editingBike, targa: e.target.value})} /></div>
                                    <div className="grid grid-cols-2 gap-4 text-left text-slate-100">
                                        <div className="space-y-1 text-left"><label className="text-[10px] font-black uppercase text-slate-500 ml-2">Km Totali</label><input required type="number" className="w-full p-4 bg-slate-900 rounded-2xl outline-none font-bold text-white text-left" value={view === 'addBike' ? newBike.odometer : editingBike.odometer} onChange={e => view === 'addBike' ? setNewBike({...newBike, odometer: e.target.value}) : setEditingBike({...editingBike, odometer: e.target.value})} /></div>
                                        <div className="space-y-1 text-left"><label className="text-[10px] font-black uppercase text-orange-500 ml-2">Km Ultimo Tagl.</label><input required type="number" className="w-full p-4 bg-slate-900 rounded-2xl outline-none font-bold text-white text-left" value={view === 'addBike' ? newBike.lastServiceKm : editingBike.lastServiceKm} onChange={e => view === 'addBike' ? setNewBike({...newBike, lastServiceKm: e.target.value}) : setEditingBike({...editingBike, lastServiceKm: e.target.value})} /></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 text-left text-slate-100">
                                        <div className="space-y-1 text-left"><label className="text-[10px] font-black uppercase text-slate-500 ml-2">Ogni Km</label><input required type="number" className="w-full p-4 bg-slate-900 rounded-2xl outline-none font-bold text-white text-left" value={view === 'addBike' ? newBike.serviceIntervalKm : editingBike.serviceIntervalKm} onChange={e => view === 'addBike' ? setNewBike({...newBike, serviceIntervalKm: e.target.value}) : setEditingBike({...editingBike, serviceIntervalKm: e.target.value})} /></div>
                                        <div className="space-y-1 text-left"><label className="text-[10px] font-black uppercase text-slate-500 ml-2">Ogni Mesi</label><input required type="number" className="w-full p-4 bg-slate-900 rounded-2xl outline-none font-bold text-white text-left" value={view === 'addBike' ? newBike.serviceIntervalMonths : editingBike.serviceIntervalMonths} onChange={e => view === 'addBike' ? setNewBike({...newBike, serviceIntervalMonths: e.target.value}) : setEditingBike({...editingBike, serviceIntervalMonths: e.target.value})} /></div>
                                    </div>
                                    <div className="space-y-1 text-left"><label className="text-[10px] font-black uppercase text-slate-500 ml-2">Data Ultimo Tagl.</label><input required type="date" className="w-full p-4 bg-slate-900 rounded-2xl outline-none font-bold text-white text-left text-white" value={view === 'addBike' ? newBike.lastServiceDate : editingBike.lastServiceDate} onChange={e => view === 'addBike' ? setNewBike({...newBike, lastServiceDate: e.target.value}) : setEditingBike({...editingBike, lastServiceDate: e.target.value})} /></div>
                                    <button className="w-full bg-orange-500 p-5 rounded-2xl font-black uppercase italic shadow-lg text-white active:scale-95 transition-all mt-4 text-center">Salva Veicolo</button>
                                </form>
                            </div>
                        )}

                        {view === 'admin' && isAdmin && (
                            <div className="p-6 animate-in space-y-8 pb-40 text-left text-slate-100 text-left">
                                <h2 className="text-3xl font-black italic uppercase text-white text-left">Admin Panel</h2>
                                <div className={`p-7 rounded-[2.5rem] shadow-xl border space-y-4 transition-colors ${editingUser ? 'bg-blue-900 border-blue-700' : 'bg-slate-900 border-slate-800'}`}>
                                    <h3 className="font-black uppercase text-xs text-orange-500 ml-2 text-left">{editingUser ? "Modifica Cliente" : "Crea Accesso Cliente"}</h3>
                                    <input placeholder="Email Account" className="w-full p-4 bg-slate-800 border border-slate-700 rounded-xl outline-none text-white font-bold text-left" value={newUser.email} onChange={e => setNewUser({...newUser, email: e.target.value})}/>
                                    <input placeholder="Password" type="text" className="w-full p-4 bg-slate-800 border border-slate-700 rounded-xl outline-none text-white font-bold text-left" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})}/>
                                    <button onClick={async () => {
                                        const path = `artifacts/garage_snoopy_final/public/data/users`;
                                        if (editingUser) { await db.doc(`${path}/${editingUser.id}`).update(newUser); setEditingUser(null); }
                                        else { await db.collection(path).add({...newUser, createdAt: new Date().toISOString()}); }
                                        setNewUser({email:'', password:'', role:'user'}); showToast("Salvato ✓");
                                    }} className="w-full bg-blue-600 p-5 rounded-2xl font-black uppercase italic shadow-lg text-white text-center text-white">Salva Credenziali</button>
                                </div>
                                <div className="space-y-3 text-left">
                                    {allUsers.map(u => (
                                        <div key={u.id} className="p-4 bg-white rounded-3xl flex justify-between items-center shadow-lg text-slate-900">
                                            <div className="flex-1 overflow-hidden text-left"><p className="font-black text-sm text-slate-900 truncate text-left">{u.email}</p><span className="text-[8px] font-black uppercase bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 border border-slate-200 text-left">{u.role}</span></div>
                                            <div className="flex gap-2 text-center text-center">
                                                <button onClick={() => { setEditingUser(u); setNewUser({email:u.email, password:u.password, role:u.role||'user'}); }} className="p-3 bg-blue-50 text-blue-600 rounded-xl active:scale-90 text-center"><Icon name="edit"/></button>
                                                <button onClick={async () => { if(confirm("Eliminare definitivamente?")) await db.doc(`artifacts/garage_snoopy_final/public/data/users/${u.id}`).delete(); }} className="p-3 bg-red-50 text-red-500 rounded-xl active:scale-90 text-center"><Icon name="trash-alt"/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {session && (
                        <nav className="fixed bottom-0 left-0 right-0 p-4 pb-8 bg-slate-900/95 backdrop-blur-md border-t border-slate-800 flex justify-around items-center max-w-[480px] mx-auto rounded-t-[3rem] shadow-2xl z-40 text-center text-slate-100">
                            <button onClick={() => { setSelectedBikeId(null); setView('garage'); }} className={`flex flex-col items-center gap-1 ${view === 'garage' ? 'text-orange-500' : 'text-slate-500'}`}><Icon name="motorcycle" size="lg"/><span className="text-[9px] font-black uppercase tracking-tighter text-center">Garage</span></button>
                            <button onClick={() => setView('history')} className={`flex flex-col items-center gap-1 ${view === 'history' ? 'text-orange-500' : 'text-slate-500'}`}><Icon name="history" size="lg"/><span className="text-[9px] font-black uppercase tracking-tighter text-center">Registro</span></button>
                            <div className="relative -top-12 text-center">
                                <button onClick={() => { if(selectedBikeId) setView('addLog'); else showToast("Scegli un veicolo!"); }} className={`p-5 rounded-full shadow-2xl border-4 border-slate-900 active:scale-90 transition-all ${selectedBikeId ? 'bg-orange-500 text-white' : 'bg-slate-700 text-slate-500'}`}><Icon name="plus" size="lg"/></button>
                            </div>
                            <button onClick={() => { if(selectedBikeId) setView('dashboard'); else showToast("Scegli un veicolo!"); }} className={`flex flex-col items-center gap-1 ${view === 'dashboard' ? 'text-orange-500' : 'text-slate-500'} ${!selectedBikeId ? 'opacity-30' : ''}`}><Icon name="tachometer-alt" size="lg"/><span className="text-[9px] font-black uppercase tracking-tighter text-center text-center">Stato</span></button>
                            <button onClick={() => setView('admin')} className={`flex flex-col items-center gap-1 ${view === 'admin' ? 'text-orange-500' : 'text-slate-500'}`}><Icon name="user-shield" size="lg"/><span className="text-[9px] font-black uppercase tracking-tighter text-center text-center">Admin</span></button>
                        </nav>
                    )}

                    {confirmDelete && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 modal-overlay animate-in">
                            <div className="bg-slate-800 w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl space-y-6 text-center border border-slate-700 text-left">
                                <div className="mx-auto w-fit p-4 bg-red-500/10 text-red-500 rounded-full text-center text-center text-center"><Icon name="exclamation-triangle" size="2x"/></div>
                                <h3 className="text-xl font-black uppercase italic tracking-tighter text-white text-center">Elimina Veicolo?</h3>
                                <p className="text-sm text-slate-400 font-medium text-center">Rimuovere definitivamente <strong>{confirmDelete.model}</strong>?</p>
                                <div className="flex flex-col gap-2 pt-2 text-center text-white text-center">
                                    <button onClick={() => handleDeleteBike(confirmDelete.id)} className="w-full bg-red-600 text-white p-4 rounded-2xl font-black uppercase text-xs shadow-lg active:scale-95 italic text-white text-center">Sì, Elimina Ora</button>
                                    <button onClick={() => setConfirmDelete(null)} className="w-full bg-slate-700 text-slate-400 p-4 rounded-2xl font-black uppercase text-xs active:scale-95 italic text-slate-400 text-center">Annulla</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {status && (
                        <div className="toast-container animate-in text-center text-white">
                            <div className="bg-slate-900 border border-slate-700 p-4 rounded-2xl flex items-center gap-3 shadow-2xl shadow-black/50 text-center text-left">
                                <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse text-center"/>
                                <p className="text-xs font-black uppercase tracking-widest text-white text-center text-center">{status}</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
